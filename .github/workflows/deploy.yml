name: Deploy Application (GCP & AWS)

on:
  push:
    branches:
      - master
      - develop
  pull_request:
    types: [opened, synchronize, reopened]

env:
  AWS_REGION: us-east-1
  ECR_REPOSITORY: fastgraph-gateway
  ECS_SERVICE: fastgraph-gateway-service
  ECS_CLUSTER: fastgraph-cluster
  ECS_TASK_DEFINITION: aws/gateway-task-def.json
  CONTAINER_NAME: guardian-gateway
  GCP_REGION: us-central1
  ARTIFACT_REGISTRY: us-central1-docker.pkg.dev/mcpstore-474903/guardian-repo

jobs:
  # ------------------------------------------------------------------
  # CHANGES: Detect which files changed
  # ------------------------------------------------------------------
  changes:
    runs-on: ubuntu-latest
    outputs:
      server: ${{ steps.filter.outputs.server }}
      client: ${{ steps.filter.outputs.client }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Detect Changes
        id: filter
        run: |
          echo "Detecting changes..."
          
          # Default to false
          SERVER_CHANGED="false"
          CLIENT_CHANGED="false"

          # If this is a PR, diff against the base branch
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            BASE_REF="origin/${{ github.base_ref }}"
            HEAD_REF="${{ github.event.pull_request.head.sha }}"
            echo "PR Detected. Diffing $BASE_REF...$HEAD_REF"
            CHANGED_FILES=$(git diff --name-only $BASE_REF $HEAD_REF || echo "")
          else
            # For push, diff against the previous commit
            BEFORE="${{ github.event.before }}"
            AFTER="${{ github.sha }}"
            echo "Push Detected. Diffing $BEFORE...$AFTER"
            # Handle force push or new branch case where 'before' might be empty or zero
            if [ -z "$BEFORE" ] || [ "$BEFORE" == "0000000000000000000000000000000000000000" ]; then
               CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD || echo "")
            else
               CHANGED_FILES=$(git diff --name-only $BEFORE $AFTER || echo "")
            fi
          fi

          echo "Changed Files:"
          echo "$CHANGED_FILES"

          if echo "$CHANGED_FILES" | grep -qE "^server/|^\.github/workflows/deploy.yml|^aws/gateway-task-def.json"; then
            SERVER_CHANGED="true"
          fi

          if echo "$CHANGED_FILES" | grep -qE "^client-next/|^\.github/workflows/deploy.yml"; then
            CLIENT_CHANGED="true"
          fi

          echo "Server Changed: $SERVER_CHANGED"
          echo "Client Changed: $CLIENT_CHANGED"

          echo "server=$SERVER_CHANGED" >> $GITHUB_OUTPUT
          echo "client=$CLIENT_CHANGED" >> $GITHUB_OUTPUT

  # ------------------------------------------------------------------
  # BACKEND VALIDATION (Runs on PRs & Push if server changes)
  # ------------------------------------------------------------------
  test:
    name: Run Backend Tests
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'

      - name: Setup Test Environment
        run: |
          chmod +x installer_v0.4.1/linux/fastgraph
          cp installer_v0.4.1/linux/fastgraph server/fastgraph
          chmod +x server/fastgraph

      - name: Run Tests
        run: |
          cd server
          go test -v ./...

  lint:
    name: Run Backend Linter
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Run Linter
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          working-directory: server
          args: --timeout=5m

  security:
    name: Security Scan
    needs: changes
    if: ${{ needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.24'
      - name: Install Gosec
        run: go install github.com/securego/gosec/v2/cmd/gosec@latest
      - name: Security Scan
        run: |
          cd server
          gosec ./...

  # ------------------------------------------------------------------
  # BACKEND DEPLOY (Runs ONLY on Master Push & Success & Server changes)
  # ------------------------------------------------------------------
  deploy_backend:
    name: Deploy Backend (GCP)
    needs: 
      - changes
      - test
      - lint
      - security
    if: ${{ github.ref == 'refs/heads/master' && needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Configure Docker Auth'
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: 'Build and Push Container'
        run: |
          docker build -t $ARTIFACT_REGISTRY/guardian-gateway:${{ github.sha }} -f server/Dockerfile .
          docker push $ARTIFACT_REGISTRY/guardian-gateway:${{ github.sha }}

      - name: 'Deploy to Cloud Run'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'guardian-gateway'
          image: '${{ env.ARTIFACT_REGISTRY }}/guardian-gateway:${{ github.sha }}'
          region: '${{ env.GCP_REGION }}'

  # ------------------------------------------------------------------
  # FRONTEND VALIDATION (Runs on PRs & Push if client changes)
  # ------------------------------------------------------------------
  test_client:
    name: Run Frontend Build Check
    needs: changes
    if: ${{ needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: client-next/package-lock.json

      - name: Install Dependencies
        run: |
          cd client-next
          npm ci

      - name: Run Build Check
        run: |
          cd client-next
          npm run build

  # ------------------------------------------------------------------
  # FRONTEND DEPLOY (Runs ONLY on Master Push & Client changes)
  # ------------------------------------------------------------------
  deploy_frontend:
    name: Deploy Frontend (GCP)
    needs: changes
    # Frontend validation can be added here as separate jobs (test, lint) if needed
    if: ${{ github.ref == 'refs/heads/master' && needs.changes.outputs.client == 'true' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - id: 'auth'
        name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: 'Set up Cloud SDK'
        uses: 'google-github-actions/setup-gcloud@v2'

      - name: 'Configure Docker Auth'
        run: |
          gcloud auth configure-docker us-central1-docker.pkg.dev

      - name: 'Build and Push Container'
        run: |
          docker build -t $ARTIFACT_REGISTRY/guardian-client:${{ github.sha }} client-next
          docker push $ARTIFACT_REGISTRY/guardian-client:${{ github.sha }}

      - name: 'Deploy to Cloud Run'
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'guardian-client'
          image: '${{ env.ARTIFACT_REGISTRY }}/guardian-client:${{ github.sha }}'
          region: '${{ env.GCP_REGION }}'

  # ------------------------------------------------------------------
  # AWS BACKEND (Legacy/Backup) - Mirrors Backend Logic
  # ------------------------------------------------------------------
  deploy_aws:
    name: Deploy Backend (AWS)
    needs: 
      - changes
      - test
      - lint
      - security
    if: ${{ github.ref == 'refs/heads/master' && needs.changes.outputs.server == 'true' }}
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        id: build-image
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -f server/Dockerfile .
          docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
          echo "image=$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG" >> $GITHUB_OUTPUT

      - name: Fill in the new image ID in the Amazon ECS task definition
        id: task-def
        uses: aws-actions/amazon-ecs-render-task-definition@v1
        with:
          task-definition: ${{ env.ECS_TASK_DEFINITION }}
          container-name: ${{ env.CONTAINER_NAME }}
          image: ${{ steps.build-image.outputs.image }}

      - name: Deploy Amazon ECS task definition
        uses: aws-actions/amazon-ecs-deploy-task-definition@v1
        with:
          task-definition: ${{ steps.task-def.outputs.task-definition }}
          service: ${{ env.ECS_SERVICE }}
          cluster: ${{ env.ECS_CLUSTER }}
          wait-for-service-stability: true
